name: Update cache from SVN

on:
  workflow_call:
    inputs:
      retry_count:
        description: "Retry count for SVN fetch"
        required: false
        default: 0
        type: number
      fetch_timeout:
        description: "Timeout for SVN fetch command in seconds"
        required: false
        default: 1201
        type: number
      max_attempts:
        description: "Max attempts for SVN fetch loop"
        required: false
        default: 3
        type: number
    outputs:
      SVN_FETCH_STATUS:
        description: "Status of the SVN fetch operation"
        value: ${{ jobs.mirror.outputs.SVN_FETCH_STATUS }}
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      retry_count:
        description: "Retry count for SVN fetch"
        required: false
        default: 0
        type: number
      fetch_timeout:
        description: "Timeout for SVN fetch command in seconds"
        required: false
        default: 1201
        type: number
      max_attempts:
        description: "Max attempts for SVN fetch loop"
        required: false
        default: 3
        type: number

  #schedule:
  #- cron: '59 */3 * * *' # every third hour to keep cache up to date

concurrency:
  group: update-svn-cache-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # This workflow contains a single job called "build"
  mirror:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      SVN_FETCH_STATUS: ${{ steps.fetchsvn.outputs.SVN_FETCH_STATUS }}

    steps:
      - name: create tmpfs
        run: |
          sudo mkdir -p src/fhem-mirror
          sudo mount -t tmpfs -o size=1g tmpfs src/fhem-mirror

      - name: install git-svn and gh package
        run: |
          sudo apt-get remove git git-man
          sudo apt-get update
          sudo apt-get install subversion git-svn gh -y --no-install-recommends

      - name: checkout authors
        uses: actions/checkout@v5.0.0
        with:
          ref: travis
          path: ./authors

      - name: generate merged authors file
        run: |
          cd /tmp
          svn log https://svn.fhem.de/fhem --xml --quiet | grep author | sort -u | perl -pe 's/.*>(.*?)<.*/$1 = $1 <>/' > ${GITHUB_WORKSPACE}/authors/authors_svn.txt;
          cat ${GITHUB_WORKSPACE}/authors/authors.txt ${GITHUB_WORKSPACE}/authors/authors_svn.txt | sort -u -k1,1 > ${GITHUB_WORKSPACE}/authors/authors_merged.txt;
          ls -la ${GITHUB_WORKSPACE}/authors/authors_merged.txt;

      - name: Get current date 
        id: get-date
        run: |
          echo "timestamp=$(/bin/date -u "+%Y%m%d%H" )" >> $GITHUB_OUTPUT
        shell: bash

      - name: Restore cache runners svn-2-git-fhem mirror directory
        # Some room for improvement because we create a new cache on every run where a new ref is fetched, this isn't very nice, normaly we need only the last one and it takes 7 days until they are deleted
        id: cache-fhem-restore
        uses: actions/cache/restore@v4.3.0
        with:
          path: |
            ./src/fhem-mirror/.git
          key: ${{ runner.os }}-fhemsvndir-${{ steps.get-date.outputs.timestamp }}
          restore-keys: |
            ${{ runner.os }}-fhemsvndir-

      #- name: remove gitconfig
      #  run: |
      #    rm ./src/fhem-mirror/.git/config 
   
      - name: fetch from svn
        id: fetchsvn
        timeout-minutes: 120
        working-directory: ./src/fhem-mirror
        run: |
          FETCH_TIMEOUT=${{ inputs.fetch_timeout }}
          if [[ "${{ github.ref }}" != "refs/heads/master" && "$FETCH_TIMEOUT" == "1201" ]]; then
            FETCH_TIMEOUT=30
          fi

          echo "::group::git svn init"
          git svn init --trunk=trunk --tags=tags --prefix=svn/ https://svn.fhem.de/fhem;
          git config --replace-all svn.authorsfile "${GITHUB_WORKSPACE}/authors/authors_merged.txt"
          git config --replace-all svn-remote.svn.preserve-empty-dirs "true" ;
          git config --replace-all svn-remote.svn.placeholder-filename ".gitkeep" ;
          echo "Current .git/config file content:";
          cat ${GITHUB_WORKSPACE}/src/fhem-mirror/.git/config;
          echo "::endgroup::"
          
          echo "SVN_FETCH_STATUS=incomplete" >> $GITHUB_OUTPUT
          # Run fetches after init, go pick up some base refs for the cache on first run only!
          RET=124
          c=1
          while [ $RET -eq 124 ]; do
            echo "::group::Fetch ${c}/${{ inputs.max_attempts }}"
            timeout $FETCH_TIMEOUT git svn --log-window-size=200 -q fetch && RET=$? || true
            if [ "$RET" -ne 0 ] && [ "$RET" -ne 124 ]; then
              echo "SVN_FETCH_STATUS=error" >> $GITHUB_OUTPUT
            fi
            ((c++)) && ((c > ${{ inputs.max_attempts }})) && break
            echo "::endgroup::"
          done
          if [ "$RET" -eq 0 ]; then          
            echo "SVN_FETCH_STATUS=complete" >> $GITHUB_OUTPUT
          fi

     # - name: Copy Workflow Files to target
     #   if: ${{ steps.fetchsvn.outputs.SVN_FETCH_STATUS == 'complete' }}
     # run: |
     #   cp -R ${GITHUB_WORKSPACE}/main/.github ./src/fhem-mirror

      - name: Checkout repository for gh CLI
        uses: actions/checkout@v5
        with:
          path: ref_branch

      - name: Delete Previous Cache
        working-directory: ./ref_branch
        id: cache-fhem-delete
        if: ${{ steps.cache-fhem-restore.outputs.cache-hit == 'true' && steps.fetchsvn.outputs.SVN_FETCH_STATUS != 'error' }}
        continue-on-error: true
        run: |
          gh extension install actions/gh-actions-cache
          gh actions-cache delete "${{ runner.os }}-fhemsvndir-${{ steps.get-date.outputs.timestamp }}" --confirm
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save cache runners svn-2-git-fhem mirror directory
        id: cache-fhem-save
        uses: actions/cache/save@v4.3.0
        if: always() 
        with:
          path: |
            ./src/fhem-mirror/.git
          key: ${{ runner.os }}-fhemsvndir-${{ steps.get-date.outputs.timestamp }}

      - name: Verify no fetch error state
        if: ${{ steps.fetchsvn.outputs.SVN_FETCH_STATUS == 'error' }}
        run: |
          echo "A permanent error occured"
          exit 1

      - name: Trigger workflow retry
        working-directory: ./ref_branch
        if: ${{ steps.fetchsvn.outputs.SVN_FETCH_STATUS == 'incomplete' && inputs.retry_count < 2 }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering retry $(( ${{ inputs.retry_count }} + 1 ))..."
          gh workflow run cache.yml --ref ${{ github.ref_name }} -f retry_count=$(( ${{ inputs.retry_count }} + 1 )) -f fetch_timeout=${{ inputs.fetch_timeout }} -f max_attempts=${{ inputs.max_attempts }}
